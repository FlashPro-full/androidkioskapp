{{> head title=title}}
<body>
  {{> nav}}
  <div class="page">
    <div class="container">
      {{#if status}}
        <div class="status-message">{{status}}</div>
      {{/if}}
      <form method="post" action="/dashboard/devices/bulk/commands" class="bulk-form">
        <div class="card card--full">
          <div class="card-header">
            <h2>Registered Devices</h2>
            <div class="card-actions">
              {{#if (eq user.role 'ADMIN')}}
              <a class="btn-link" href="/dashboard/devices/new">+ Register Device</a>
              {{/if}}
            </div>
          </div>
          {{#if (eq user.role 'ADMIN')}}
          <div class="apk-upload-section">
            <h3>APK Management</h3>
            <form method="post" action="/dashboard/upload/apk" enctype="multipart/form-data" class="apk-upload-form">
              <div class="form-group">
                <label for="apk-file">Upload/Replace Kiosk APK</label>
                <input type="file" id="apk-file" name="apk" accept=".apk,application/vnd.android.package-archive" required>
                <small>Maximum file size: 100MB. This will replace any existing uploaded APK.</small>
              </div>
              <button type="submit" class="btn-primary">Upload APK</button>
            </form>
          </div>
          {{/if}}
          {{#if devices.length}}
            <table>
              <thead>
                <tr>
                  <th>
                    <input type="checkbox" id="selectAll" />
                  </th>
                  <th>Name</th>
                  <th>Allowed Package</th>
                  <th>Status</th>
                  <th>Last Check-In</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {{#each devices}}
                  <tr>
                    <td>
                      <input type="checkbox" name="deviceIds" value="{{this.id}}" />
                    </td>
                    <td>{{this.displayName}}</td>
                    <td>{{this.allowedPackage}}</td>
                    <td>
                      <span class="status-badge status-{{statusClass this.status}}">
                        {{statusLabel this.status}}
                      </span>
                    </td>
                    <td>{{formatDate this.lastCheckIn}}</td>
                    <td><a href="/dashboard/devices/{{this.id}}">View</a></td>
                  </tr>
                {{/each}}
              </tbody>
            </table>
            {{#if (or (eq user.role 'ADMIN') (eq user.role 'TECHNICIAN'))}}
            <div class="bulk-actions">
              <div class="bulk-actions__group">
                <label>Bulk action</label>
                <select name="action" required>
                  <option value="">Select action</option>
                  <option value="pin">Rotate PIN</option>
                  <option value="package">Change package</option>
                  <option value="reboot">Remote reboot</option>
                </select>
              </div>
              <div class="bulk-actions__group">
                <input type="text" name="pin" placeholder="New PIN">
              </div>
              <div class="bulk-actions__group">
                <input type="text" name="allowedPackage" placeholder="New package">
              </div>
              <button type="submit" class="btn-primary">Queue command</button>
            </div>
            {{/if}}
          {{else}}
            <p>No devices registered yet.</p>
          {{/if}}
        </div>
      </form>
    </div>
  </div>
{{> footer}}


{{> head title=title}}
<body>
  {{> nav}}
  <div class="page">
    <div class="container">
      {{#if status}}
        <div class="status-message">{{status}}</div>
      {{/if}}
      {{#if token}}
        <div class="status-message">
          <strong>Device token:</strong>
          <code>{{token}}</code>
          <br />
          Share this with installers securely. It will not be shown again.
        </div>
      {{/if}}

      <div class="card">
        <h2>{{device.displayName}}</h2>
        <p class="device-summary">
          <span class="device-summary__row">
            <span class="device-summary__label">Status</span>
            <span class="device-summary__value">
              <span class="status-badge status-{{statusClass device.status}}">
                {{statusLabel device.status}}
              </span>
            </span>
          </span>
          <span class="device-summary__row">
            <span class="device-summary__label">Allowed package</span>
            <span class="device-summary__value">{{device.allowedPackage}}</span>
          </span>
          <span class="device-summary__row">
            <span class="device-summary__label">Last check-in</span>
            <span class="device-summary__value">{{formatDate device.lastCheckIn}}</span>
          </span>
          <span class="device-summary__row">
            <span class="device-summary__label">Last command</span>
            <span class="device-summary__value">{{formatDate device.lastCommandAt}}</span>
          </span>
        </p>

        <div class="actions">
          <form method="post" action="/dashboard/devices/{{device.id}}/commands/pin">
            <div class="form-group">
              <label for="pin">Rotate PIN</label>
              <input type="number" id="pin" name="pin" minlength="4" required />
            </div>
            <button type="submit">Queue PIN Update</button>
          </form>

          <form
            method="post"
            action="/dashboard/devices/{{device.id}}/commands/package"
          >
            <div class="form-group">
              <label for="allowedPackage">Allowed package</label>
              <input
                type="text"
                id="allowedPackage"
                name="allowedPackage"
                value="{{device.allowedPackage}}"
                required
              />
            </div>
            <button type="submit">Queue Package Update</button>
          </form>

          <form method="post" action="/dashboard/devices/{{device.id}}/commands/reboot">
            <label>&nbsp;</label>
            <button type="submit" class="danger">Send Reboot</button>
          </form>

          <form method="post" action="/dashboard/devices/{{device.id}}/token">
            <label>&nbsp;</label>
            <button type="submit" class="secondary">Rotate Device Token</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Provisioning Extras</h3>
          <div class="card-actions">
            {{#if qr}}
              <a class="btn-link secondary" href="/dashboard/devices/{{device.id}}">Hide QR</a>
            {{else}}
              <a class="btn-link secondary" href="/dashboard/devices/{{device.id}}?showQr=1">Show QR</a>
            {{/if}}
          </div>
        </div>
        <ul class="kv-list">
          <li class="kv-list__item">
            <span class="kv-list__label">Portal URL</span>
            <span class="kv-list__value">{{provisioning.portal_url}}</span>
          </li>
          <li class="kv-list__item">
            <span class="kv-list__label">Device ID</span>
            <span class="kv-list__value">{{provisioning.device_id}}</span>
          </li>
          <li class="kv-list__item">
            <span class="kv-list__label">Device Token</span>
            <span class="kv-list__value">{{provisioning.device_token}}</span>
          </li>
          <li class="kv-list__item">
            <span class="kv-list__label">Allowed package</span>
            <span class="kv-list__value">{{provisioning.allowed_package}}</span>
          </li>
          <li class="kv-list__item">
            <span class="kv-list__label">Initial PIN</span>
            <span class="kv-list__value">{{provisioning.initial_pin}}</span>
          </li>
        </ul>
        {{#if qr}}
          <div class="qr-block">
            <img class="qr-block__image" src="{{qr.image}}" alt="Provisioning QR code" />
            <textarea class="qr-block__json" readonly>{{qr.json}}</textarea>
          </div>
        {{/if}}
      </div>

      <div class="card">
        <h3>Recent Commands</h3>
        {{#if commands.length}}
          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th>Status</th>
                <th>Created</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody>
              {{#each commands}}
                <tr>
                  <td>{{this.type}}</td>
                  <td>{{this.status}}</td>
                  <td>{{formatDate this.createdAt}}</td>
                  <td>{{formatDate this.updatedAt}}</td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        {{else}}
          <p>No commands queued.</p>
        {{/if}}
      </div>
    </div>
  </div>
{{> footer}}


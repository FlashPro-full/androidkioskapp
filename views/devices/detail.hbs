{{> head title=title}}
<body>
  {{> nav}}
  <div class="page">
    <div class="container container--device-detail">
      {{#if status}}
        <div class="status-message">{{status}}</div>
      {{/if}}
      {{#if token}}
        <div class="status-message">
          <strong>Device token:</strong>
          <code>{{token}}</code>
          <br />
          Share this with installers securely. It will not be shown again.
        </div>
      {{/if}}

      <div class="card">
        <h2>{{device.displayName}}</h2>
        <p class="device-summary">
          <span class="device-summary__row">
            <span class="device-summary__label">Status</span>
            <span class="device-summary__value">
              <span class="status-badge status-{{statusClass device.status}}">
                {{statusLabel device.status}}
              </span>
            </span>
          </span>
          <span class="device-summary__row">
            <span class="device-summary__label">Allowed package</span>
            <span class="device-summary__value">{{device.allowedPackage}}</span>
          </span>
          <span class="device-summary__row">
            <span class="device-summary__label">Last check-in</span>
            <span class="device-summary__value">{{formatDate device.lastCheckIn}}</span>
          </span>
          <span class="device-summary__row">
            <span class="device-summary__label">Last command</span>
            <span class="device-summary__value">{{formatDate device.lastCommandAt}}</span>
          </span>
          {{#if latestHeartbeat}}
            {{#if latestHeartbeat.deviceSerial}}
            <span class="device-summary__row">
              <span class="device-summary__label">Device Serial</span>
              <span class="device-summary__value"><code>{{latestHeartbeat.deviceSerial}}</code></span>
            </span>
            {{/if}}
          {{/if}}
        </p>

        {{#if (or (eq user.role 'ADMIN') (eq user.role 'TECHNICIAN'))}}
        <div class="actions">
          <form method="post" action="/dashboard/devices/{{device.id}}/commands/pin" class="action-form">
            <div class="form-group-inline">
              <div class="input-with-check">
                <input type="text" id="pin" name="pin" minlength="4" placeholder="Rotate PIN" required data-original-value="" />
                <button type="submit" class="check-btn" disabled title="Apply PIN change">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </form>

          <form
            method="post"
            action="/dashboard/devices/{{device.id}}/commands/package"
            class="action-form"
          >
            <div class="form-group-inline">
              <div class="input-with-check">
                <input
                  type="text"
                  id="allowedPackage"
                  name="allowedPackage"
                  placeholder="Allowed package"
                  value="{{device.allowedPackage}}"
                  required
                  data-original-value="{{device.allowedPackage}}"
                />
                <button type="submit" class="check-btn" disabled title="Apply package change">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </form>

          <form method="post" action="/dashboard/devices/{{device.id}}/commands/reboot" class="action-form">
            <button type="submit" class="danger">Send Reboot</button>
          </form>
        </div>
        {{/if}}

        {{#if (eq user.role 'ADMIN')}}
        <div class="actions">
          <form method="post" action="/dashboard/devices/{{device.id}}/token" class="action-form">
            <button type="submit" class="secondary">Rotate Device Token</button>
          </form>

          <form method="post" action="/dashboard/devices/{{device.id}}/expected-serial" class="action-form">
            <div class="form-group-inline">
              <div class="input-with-check">
                <input
                  type="text"
                  id="expectedDeviceSerial"
                  name="expectedDeviceSerial"
                  value="{{device.expectedDeviceSerial}}"
                  placeholder="Expected Device Serial/Android ID"
                  data-original-value="{{device.expectedDeviceSerial}}"
                />
                <button type="submit" class="check-btn" disabled title="Apply serial change">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </form>
        </div>
        {{/if}}
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Provisioning Extras</h3>
          {{#if canViewQr}}
          <div class="card-actions">
            {{#if qr}}
              <a class="btn-link secondary" href="/dashboard/devices/{{device.id}}">Hide QR</a>
            {{else}}
              <a class="btn-link secondary" href="/dashboard/devices/{{device.id}}?showQr=1">Show QR</a>
            {{/if}}
          </div>
          {{/if}}
        </div>
        {{#unless canViewQr}}
        <div style="padding: 16px; background-color: #f5f5f5; border-radius: 4px; margin-bottom: 16px;">
          <p style="margin: 0; color: #666;">
            <strong>Access Restricted:</strong> QR codes and sensitive provisioning data are only available to Administrators and Technicians. Contact an administrator if you need to provision a device.
          </p>
        </div>
        {{/unless}}
        <ul class="kv-list">
          <li class="kv-list__item">
            <span class="kv-list__label">Portal URL</span>
            <span class="kv-list__value">{{provisioning.portal_url}}</span>
          </li>
          <li class="kv-list__item">
            <span class="kv-list__label">Device ID</span>
            <span class="kv-list__value">{{provisioning.device_id}}</span>
          </li>
          <li class="kv-list__item">
            <span class="kv-list__label">Device Token</span>
            <span class="kv-list__value">{{provisioning.device_token}}</span>
          </li>
          <li class="kv-list__item">
            <span class="kv-list__label">Allowed package</span>
            <span class="kv-list__value">{{provisioning.allowed_package}}</span>
          </li>
          <li class="kv-list__item">
            <span class="kv-list__label">Initial PIN</span>
            <span class="kv-list__value">{{provisioning.initial_pin}}</span>
          </li>
          {{#if provisioning.expected_device_serial}}
          <li class="kv-list__item">
            <span class="kv-list__label">Expected Device Serial</span>
            <span class="kv-list__value"><code>{{provisioning.expected_device_serial}}</code></span>
          </li>
          {{/if}}
        </ul>
        {{#if qr}}
          <div class="qr-block">
            <img class="qr-block__image" src="{{qr.image}}" alt="Provisioning QR code" />
            <textarea class="qr-block__json" readonly>{{qr.json}}</textarea>
          </div>
        {{/if}}
      </div>

      <div class="card">
        <h3>Recent Commands</h3>
        {{#if commands.length}}
          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th>Status</th>
                <th>Created</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody>
              {{#each commands}}
                <tr>
                  <td>{{this.type}}</td>
                  <td>{{this.status}}</td>
                  <td>{{formatDate this.createdAt}}</td>
                  <td>{{formatDate this.updatedAt}}</td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        {{else}}
          <p>No commands queued.</p>
        {{/if}}
      </div>
    </div>
  </div>
{{> footer}}

<script>
  // Track input changes and enable/disable check buttons
  document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input[data-original-value]');
    
    inputs.forEach(input => {
      const originalValueAttr = input.getAttribute('data-original-value');
      const originalValue = originalValueAttr !== null ? originalValueAttr : '';
      const form = input.closest('form');
      const checkBtn = form?.querySelector('.check-btn');
      
      if (!checkBtn) return;
      
      // Check initial state
      function checkInputChange() {
        const currentValue = input.value.trim();
        // For PIN input (empty original), enable if value is valid (4+ digits)
        // For other inputs, enable if value changed and is not empty (or if original was empty and now has value)
        let hasChanged = false;
        
        if (originalValue === '') {
          // PIN input or empty original - enable if has valid value
          if (input.type === 'number') {
            hasChanged = currentValue.length >= 4;
          } else {
            hasChanged = currentValue !== '';
          }
        } else {
          // Has original value - enable if changed
          hasChanged = currentValue !== originalValue;
        }
        
        if (hasChanged) {
          checkBtn.disabled = false;
          checkBtn.classList.add('active');
        } else {
          checkBtn.disabled = true;
          checkBtn.classList.remove('active');
        }
      }
      
      // Check on input
      input.addEventListener('input', checkInputChange);
      
      // Check on page load
      checkInputChange();
      
      // Reset after form submission (if page doesn't reload)
      form.addEventListener('submit', function() {
        setTimeout(() => {
          const newValue = input.value.trim();
          input.setAttribute('data-original-value', newValue);
          checkInputChange();
        }, 100);
      });
    });
  });
</script>

